{% extends 'base.html' %}
{% load static %}

{% block title %}Procedure Prediction - MEDIPREDICT{% endblock %}

{% block content %}
<!-- Link CSS file -->
<link rel="stylesheet" href="{% static 'css/predictproc.css' %}">

<!-- PART 1: HERO HEADER -->
<section class="predict-hero-proc">
    <div class="hero-overlay-proc"></div>
    <div class="container position-relative z-2">
        <div class="hero-content-proc">
            <span class="tagline-proc"><i class="fas fa-procedures"></i> AI PREDICT</span>
            <h1>Medical Procedure Prediction</h1>
            <p>Enter ICD diagnoses for AI to suggest the most suitable procedures.</p>
        </div>
    </div>
</section>

<!-- PART 2: TWO-COLUMN CONTENT -->
<section class="procedure-content">
    <div class="container two-column-layout-proc">

        <!-- LEFT: DIAGNOSIS INPUT FORM -->
        <div class="column-left-proc card-effect-proc">
            <div class="form-header-custom-proc">
                <div class="header-icon-box-proc">
                    <i class="fas fa-file-medical"></i>
                </div>
                <div class="header-text-box-proc">
                    <h2>Diagnostic Data</h2>
                    <p>Enter ICD-9 codes or disease names to search</p>
                </div>
            </div>
            <hr class="custom-divider-proc">

            <!-- Search box -->
            <div class="autocomplete-box">
                <input type="text" id="diagInput" class="form-control form-control-lg"
                       placeholder="Example: 25000, 4019">
                <div id="autocompleteList" class="autocomplete-results" style="display:none;"></div>
            </div>

            <!-- Tag area -->
            <div id="tagArea" class="diagnosis-tag-area">
                <p id="emptyMessage" class="empty-state-message">
                    <i class="fas fa-clipboard-list"></i><br>
                    No diagnoses selected yet.
                </p>
            </div>

            <!-- Predict button -->
            <button id="predictBtn" class="btn-submit-proc">
                <span id="predictBtnIcon"><i class="fas fa-brain"></i></span>
                <span id="predictBtnText">PREDICT PROCEDURES</span>
                <span id="predictBtnSpinner" class="spinner-border spinner-border-sm" role="status" style="display:none;"></span>
            </button>
        </div>

        <!-- RIGHT: RESULTS DISPLAY -->
        <div class="column-right-proc card-effect-proc">
            <div class="results-container-proc" id="resultsContainer">
                <!-- Results will be rendered here -->
                <div class="result-placeholder-proc">
                    <div class="placeholder-icon-wrapper-proc">
                        <div class="icon-pulse-ring-proc"></div>
                        <div class="placeholder-img-modern-proc">
                            <i class="fas fa-robot"></i>
                        </div>
                    </div>
                    
                    <h4 class="empty-title-proc">AI Ready</h4>
                    <p class="empty-desc-proc">
                        No analysis data yet. <br>
                        Please enter diagnoses on the left and click 
                        <strong>"Predict Procedures"</strong>.
                    </p>
                    
                    <!-- Instruction arrow -->
                    <div class="instruction-arrow-proc">
                        <i class="fas fa-long-arrow-alt-left"></i> Input here
                    </div>
                </div>
            </div>
        </div>

    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // =========================
    // VARIABLES & DATA LOADING
    // =========================
    let diagList = [];
    let hasResult = false;  // ➜ detect if results already exist
    const selectedDiagnoses = new Map();

    const input = document.getElementById("diagInput");
    const listBox = document.getElementById("autocompleteList");
    const tagArea = document.getElementById("tagArea");
    const emptyMessage = document.getElementById("emptyMessage");
    const predictBtn = document.getElementById("predictBtn");
    const predictBtnText = document.getElementById("predictBtnText");
    const predictBtnSpinner = document.getElementById("predictBtnSpinner");
    const resultsContainer = document.getElementById("resultsContainer");

    fetch("{% static 'data/diag_list_1200.json' %}")
        .then(response => response.json())
        .then(data => diagList = data)
        .catch(err => console.error("Error loading diag_list:", err));

    // =========================
    // FUNCTION: SWITCH BUTTON ➜ CHECK NEW
    // =========================
    function switchPredictButtonToReset(){
        hasResult = true;

        // REMOVE old icon if exists
        const icon = predictBtn.querySelector('i');
        if (icon) icon.remove();

        predictBtnText.innerHTML = `<i class="fas fa-redo"></i> CHECK NEW`;
        predictBtn.classList.add('btn-reset-proc');
        predictBtn.classList.remove('btn-submit-proc');

        // Disable ICD input
        input.disabled = true;

        // Hide tag delete buttons
        document.querySelectorAll(".remove-tag-btn").forEach(btn => {
            btn.style.display = "none";
        });

        // Change onclick
        predictBtn.onclick = function(e){
            e.preventDefault();
            window.location.href = window.location.pathname;
        };
    }

    // =========================
    // RENDER FUNCTIONS
    // =========================
    const renderTags = () => {
        tagArea.innerHTML = '';
        if (selectedDiagnoses.size === 0) {
            emptyMessage.style.display = 'block';
            tagArea.appendChild(emptyMessage);
        } else {
            emptyMessage.style.display = 'none';
            selectedDiagnoses.forEach((item, code) => {
                const tag = document.createElement('div');
                tag.className = 'diagnosis-tag';
                tag.dataset.code = code;
                tag.innerHTML = `
                    <div class="tag-info">
                        <span class="tag-badge">${item.code}</span>
                        <span class="tag-name" title="${item.name}">${item.name}</span>
                    </div>
                    <button class="remove-tag-btn" title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                tagArea.appendChild(tag);

                tag.querySelector('.remove-tag-btn').onclick = () => {
                    selectedDiagnoses.delete(code);
                    renderTags();
                };
            });
        }
    };

    const renderResults = (results) => {
        if (!results || results.length === 0) {
            resultsContainer.innerHTML = `
                <div class="results-container-proc">
                    <div class="results-header-proc">
                        <div class="header-badge-proc">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h3>No Procedures Found</h3>
                    </div>
                    <div class="no-results-proc">
                        <i class="fas fa-search"></i>
                        <p>No suitable procedures found for the selected diagnoses.</p>
                    </div>
                    <div class="dash-footer-proc">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Results are for medical reference only.</span>
                    </div>
                </div>`;
            switchPredictButtonToReset();  // ✔ run reset
            return;
        }
        results.sort((a, b) => b.score - a.score);

        const itemsHTML = results.map(p => {
            // Opening brace { above to write JS logic code
            
            // 1. Color selection logic
            let colorClass = '#6c757d'; // Default: Gray
            if(p.score >= 70) {
                colorClass = '#28a745'; // Green
            } else if(p.score >= 40) {
                colorClass = '#ffc107'; // Yellow
            }

            // 2. Return HTML string
            return `
                <div class="result-item-proc">
                    <div class="result-icon-proc">
                        <i class="fas fa-syringe"></i>
                    </div>
                    <div class="result-content-proc" style="width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div class="result-code-proc">${p.code}</div>
                            <div style="font-weight: bold; color: ${colorClass}; font-size: 0.95rem;">
                                ${p.score}% <i class="fas fa-chart-pie" style="font-size: 0.8em;"></i>
                            </div>
                        </div>
                        
                        <div class="result-name-proc">${p.name}</div>
                        
                        <!-- Progress bar -->
                        <div style="width: 100%; background: #e9ecef; height: 5px; border-radius: 3px; margin-top: 8px;">
                            <div style="width: ${p.score}%; background: ${colorClass}; height: 100%; border-radius: 3px; transition: width 1s ease;"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        resultsContainer.innerHTML = `
            <div class="results-container-proc">
                <div class="results-header-proc">
                    <div class="header-badge-proc">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <h3>Prediction Results</h3>
                    </div>
                </div>
                
                <div class="stats-card-proc">
                    <div class="stats-value-proc">${results.length}</div>
                    <div class="stats-label-proc">Procedures Recommended</div>
                </div>
                
                <div class="results-list-proc">
                    ${itemsHTML}
                </div>
                
                <div class="dash-footer-proc">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Results are for medical reference only.</span>
                </div>
            </div>
        `;

        switchPredictButtonToReset(); // ✔ run reset
    };

    // =========================
    // EVENT HANDLING
    // =========================
    const addDiagnosis = (item) => {
        selectedDiagnoses.set(item.code, item);
        input.value = '';
        listBox.style.display = 'none';
        renderTags();
    };

    // Paste ICD
    input.addEventListener("paste", function(e) {
        e.preventDefault();
        let pasteData = (e.clipboardData || window.clipboardData).getData("text");
        if (!pasteData) return;

        let parts = pasteData.split(/[, \n\t]+/);
        let added = 0;
        parts.forEach(code => {
            code = code.trim();
            if (code) {
                const item = diagList.find(d => d.code === code);
                if (item) {
                    addDiagnosis(item);
                    added++;
                }
            }
        });
        if (added > 0) {
            input.value = '';
        }
    });

    // Enter to input multiple ICD
    input.addEventListener("keydown", function(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            if(hasResult) return;

            const raw = input.value.trim();
            if (!raw) return;
            
            let parts = raw.split(/[, ]+/);
            parts.forEach(code => {
                code = code.trim();
                const item = diagList.find(d => d.code === code);
                if (item) {
                    addDiagnosis(item);
                }
            });
            input.value = '';
        }
    });

    // Autocomplete
    input.addEventListener('input', function() {
        if(hasResult) return;

        const text = this.value.toLowerCase().trim();
        if (!text) { 
            listBox.style.display = 'none'; 
            return; 
        }

        const filtered = diagList.filter(item =>
            !selectedDiagnoses.has(item.code) &&
            (item.code.toLowerCase().includes(text) ||
             (item.name && item.name.toLowerCase().includes(text)))
        ).slice(0, 7);

        if (filtered.length === 0) {
            listBox.style.display = 'none';
            return;
        }

        listBox.innerHTML = filtered.map(item => `
            <div class="autocomplete-item" data-code="${item.code}">
                <strong>${item.code}</strong>
                <span>${item.name}</span>
            </div>`
        ).join('');

        listBox.querySelectorAll('.autocomplete-item').forEach(div => {
            div.onclick = () => {
                const item = diagList.find(i => i.code === div.dataset.code);
                if (item) addDiagnosis(item);
            };
        });
        listBox.style.display = 'block';
    });
    
    document.addEventListener("click", (e) => {
        if (!e.target.closest('.autocomplete-box')) {
            listBox.style.display = "none";
        }
    });

    // =========================
    // CLICK SUBMIT
    // =========================
    predictBtn.addEventListener('click', async () => {
        if(hasResult) return;

        const codes = Array.from(selectedDiagnoses.keys());
        if (codes.length === 0) {
            alert("Please add at least one diagnosis!");
            input.focus();
            return;
        }
        
        // Enable loading
        predictBtn.disabled = true;
        predictBtnText.textContent = 'Analyzing...';
        predictBtnSpinner.style.display = 'inline-block';

        resultsContainer.innerHTML = `
            <div class="results-container-proc">
                <div class="result-placeholder-proc">
                    <div class="placeholder-icon-wrapper-proc">
                        <div class="icon-pulse-ring-proc"></div>
                        <div class="placeholder-img-modern-proc">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                    <h4 class="empty-title-proc">Analyzing</h4>
                    <p class="empty-desc-proc">AI is processing ${codes.length} diagnoses...</p>
                </div>
            </div>
        `;

        try {
            const formData = new URLSearchParams({ icd_codes: codes.join(',') });
            const response = await fetch("{% url 'predictproc:procedure_api' %}", {
                method: "POST",
                headers: { 
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: formData
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            renderResults(data.results || []);
            
        } catch (error) {
            console.error('Error:', error);
            resultsContainer.innerHTML = `
                <div class="results-container-proc">
                    <div class="results-header-proc">
                        <div class="header-badge-proc" style="background: #ffebee; color: #d32f2f;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3>Analysis Error</h3>
                    </div>
                    <div class="no-results-proc">
                        <i class="fas fa-times-circle" style="color: #d32f2f;"></i>
                        <p>An error occurred during analysis. Please try again later.</p>
                    </div>
                </div>`;
            switchPredictButtonToReset();
        } finally {
            // Disable loading
            predictBtnSpinner.style.display = 'none';
            predictBtn.disabled = false;
        }
    });

    // Focus input when page loads
    setTimeout(() => {
        input.focus();
    }, 500);
});
</script>

{% endblock %}